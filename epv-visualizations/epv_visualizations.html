<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EPV Visualizations - Bruce Greenwald's Earnings Power Value</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f8f9fa;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            text-align: center;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .visualization-section {
            background: white;
            margin: 30px 0;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin: 20px 0;
        }
        .chart-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .chart-description {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.6;
        }
        .controls {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }
        .slider-container {
            margin: 15px 0;
        }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        .slider-value {
            font-weight: bold;
            color: #2c3e50;
            margin-left: 10px;
        }
        .scenario-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin: 15px 0;
        }
        .scenario-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        .scenario-btn.active {
            background-color: #3498db;
            color: white;
        }
        .scenario-btn:not(.active) {
            background-color: #ecf0f1;
            color: #2c3e50;
        }
        .scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }
        .waterfall-container {
            height: 500px;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
        }
        .legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 3px;
        }
        .export-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px 5px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        .metric-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .metric-value {
            font-size: 24px;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }
        .metric-label {
            color: #666;
            font-size: 14px;
        }
        .tabs {
            display: flex;
            margin: 20px 0;
            border-bottom: 2px solid #e9ecef;
        }
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }
        .tab.active {
            color: #3498db;
            border-bottom: 3px solid #3498db;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .comparison-table th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        .positive { color: #27ae60; }
        .negative { color: #e74c3c; }
        .neutral { color: #f39c12; }
        .animate-bar {
            animation: growBar 1.5s ease-out;
        }
        @keyframes growBar {
            from { transform: scaleY(0); transform-origin: bottom; }
            to { transform: scaleY(1); transform-origin: bottom; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>EPV Visualizations</h1>
            <p>Bruce Greenwald's Earnings Power Value Analysis Framework</p>
        </div>

        <!-- 1. Normalized Earnings Bar Chart -->
        <div class="visualization-section">
            <div class="chart-title">1. Normalized Earnings Bar Chart (Cyclical Adjustment)</div>
            <div class="chart-description">
                This chart shows how EBIT normalizes over a full business cycle, smoothing cyclical volatility. 
                The horizontal line represents the normalized average, helping identify cyclical peaks and troughs.
            </div>
            <div class="chart-container">
                <canvas id="earningsChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>Annual EBIT</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Normalized Average</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f39c12;"></div>
                    <span>Market Events</span>
                </div>
            </div>
        </div>

        <!-- 2. Maintenance Capex Breakdown Chart -->
        <div class="visualization-section">
            <div class="chart-title">2. Maintenance Capex Breakdown Chart</div>
            <div class="chart-description">
                This stacked bar chart clarifies the difference between total capex and maintenance capex required for EPV normalization.
                The horizontal line indicates the average maintenance capex over the period.
            </div>
            <div class="chart-container">
                <canvas id="capexChart"></canvas>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>Maintenance Capex</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #9b59b6;"></div>
                    <span>Growth Capex</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #e74c3c;"></div>
                    <span>Average Maintenance</span>
                </div>
            </div>
        </div>

        <!-- 3. EPV vs DCF Scenario Analysis -->
        <div class="visualization-section">
            <div class="chart-title">3. EPV vs. DCF Scenario Analysis (Interactive)</div>
            <div class="chart-description">
                This interactive chart demonstrates how sensitive DCF valuations are compared to the stable EPV across varying growth rate assumptions.
                Click on different growth rate scenarios to see the valuation differences.
            </div>
            <div class="controls">
                <div class="scenario-buttons">
                    <button class="scenario-btn active" onclick="updateScenario(0)">0% Growth</button>
                    <button class="scenario-btn" onclick="updateScenario(2)">2% Growth</button>
                    <button class="scenario-btn" onclick="updateScenario(4)">4% Growth</button>
                    <button class="scenario-btn" onclick="updateScenario(6)">6% Growth</button>
                    <button class="scenario-btn" onclick="updateScenario('all')">Show All</button>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="scenarioChart"></canvas>
            </div>
        </div>

        <!-- 4. WACC Sensitivity Line Chart -->
        <div class="visualization-section">
            <div class="chart-title">4. WACC Sensitivity Analysis (Interactive)</div>
            <div class="chart-description">
                This interactive chart showcases how EPV valuation responds to changes in the Weighted Average Cost of Capital (WACC).
                Use the slider to dynamically adjust WACC and see real-time EPV calculations.
            </div>
            <div class="controls">
                <div class="slider-container">
                    <label for="waccSlider">WACC: <span id="waccValue" class="slider-value">9.0%</span></label>
                    <input type="range" id="waccSlider" class="slider" min="6" max="12" step="0.1" value="9" onchange="updateWACCChart()">
                </div>
                <div>
                    <label for="currentPrice">Current Market Price: $<span id="currentPriceValue" class="slider-value">85.00</span></label>
                    <input type="range" id="currentPrice" class="slider" min="60" max="120" step="1" value="85" onchange="updateWACCChart()">
                </div>
            </div>
            <div class="chart-container">
                <canvas id="waccChart"></canvas>
            </div>
        </div>

        <!-- 5. EPV Component Waterfall Chart -->
        <div class="visualization-section">
            <div class="chart-title">5. EPV Component Waterfall Chart</div>
            <div class="chart-description">
                This waterfall chart provides visual clarity on each adjustment step from normalized EBIT to final EPV per share,
                reinforcing understanding of EPV's simplicity and transparency.
            </div>
            <div class="waterfall-container">
                <svg id="waterfallChart"></svg>
            </div>
            <div class="controls">
                <button class="export-btn" onclick="exportChart('waterfall')">Export Chart</button>
                <button class="export-btn" onclick="animateWaterfall()">Animate Flow</button>
            </div>
        </div>

        <!-- 6. Historical EPV vs Market Price Analysis -->
        <div class="visualization-section">
            <div class="chart-title">6. Historical EPV vs Market Price Analysis</div>
            <div class="chart-description">
                Track how EPV compares to market price over time, identifying periods of over/undervaluation and margin of safety opportunities.
            </div>
            <div class="tabs">
                <button class="tab active" onclick="switchTab('price-tab', 'price-content')">Price Comparison</button>
                <button class="tab" onclick="switchTab('margin-tab', 'margin-content')">Margin of Safety</button>
                <button class="tab" onclick="switchTab('metrics-tab', 'metrics-content')">Key Metrics</button>
            </div>
            
            <div id="price-content" class="tab-content active">
                <div class="chart-container">
                    <canvas id="priceComparisonChart"></canvas>
                </div>
            </div>
            
            <div id="margin-content" class="tab-content">
                <div class="chart-container">
                    <canvas id="marginChart"></canvas>
                </div>
            </div>
            
            <div id="metrics-content" class="tab-content">
                <div class="metrics-grid">
                    <div class="metric-card">
                        <div class="metric-value" id="currentEPV">$95.20</div>
                        <div class="metric-label">Current EPV</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="currentPrice">$85.00</div>
                        <div class="metric-label">Market Price</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value positive" id="marginOfSafety">12.0%</div>
                        <div class="metric-label">Margin of Safety</div>
                    </div>
                    <div class="metric-card">
                        <div class="metric-value" id="avgROIC">15.2%</div>
                        <div class="metric-label">Avg ROIC</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 7. Monte Carlo EPV Simulation -->
        <div class="visualization-section">
            <div class="chart-title">7. Monte Carlo EPV Simulation</div>
            <div class="chart-description">
                Simulate thousands of EPV scenarios by varying key assumptions (WACC, normalized earnings, maintenance capex) 
                to understand the probability distribution of fair value estimates.
            </div>
            <div class="controls">
                <div class="slider-container">
                    <label for="simulations">Number of Simulations: <span id="simValue" class="slider-value">5,000</span></label>
                    <input type="range" id="simulations" class="slider" min="1000" max="10000" step="500" value="5000" onchange="updateSimulations()">
                </div>
                <button class="export-btn" onclick="runMonteCarloSimulation()">Run Simulation</button>
                <button class="export-btn" onclick="exportChart('montecarlo')">Export Results</button>
            </div>
            <div class="chart-container">
                <canvas id="monteCarloChart"></canvas>
            </div>
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-value" id="mcMedian">$92.50</div>
                    <div class="metric-label">Median EPV</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="mc25th">$78.20</div>
                    <div class="metric-label">25th Percentile</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value" id="mc75th">$108.90</div>
                    <div class="metric-label">75th Percentile</div>
                </div>
                <div class="metric-card">
                    <div class="metric-value positive" id="mcUpside">67%</div>
                    <div class="metric-label">Upside Probability</div>
                </div>
            </div>
        </div>

        <!-- 8. Peer Comparison Matrix -->
        <div class="visualization-section">
            <div class="chart-title">8. Peer EPV Comparison Matrix</div>
            <div class="chart-description">
                Compare EPV metrics across industry peers to identify relative value opportunities and validate assumptions.
            </div>
            <div class="chart-container">
                <canvas id="peerComparisonChart"></canvas>
            </div>
            <table class="comparison-table">
                <thead>
                    <tr>
                        <th>Company</th>
                        <th>EPV</th>
                        <th>Market Price</th>
                        <th>Margin of Safety</th>
                        <th>ROIC</th>
                        <th>Debt/Equity</th>
                        <th>Investment Rating</th>
                    </tr>
                </thead>
                <tbody id="peerTableBody">
                    <!-- Will be populated by JavaScript -->
                </tbody>
            </table>
        </div>

        <!-- 9. Sensitivity Heat Map -->
        <div class="visualization-section">
            <div class="chart-title">9. EPV Sensitivity Heat Map</div>
            <div class="chart-description">
                Visualize how sensitive EPV is to changes in key assumptions using a comprehensive heat map analysis.
            </div>
            <div class="controls">
                <div class="scenario-buttons">
                    <button class="scenario-btn active" onclick="updateHeatMap('wacc-earnings')">WACC vs Earnings</button>
                    <button class="scenario-btn" onclick="updateHeatMap('wacc-capex')">WACC vs Capex</button>
                    <button class="scenario-btn" onclick="updateHeatMap('earnings-capex')">Earnings vs Capex</button>
                </div>
            </div>
            <div class="chart-container">
                <svg id="heatMapChart"></svg>
            </div>
        </div>

        <!-- Export and Analysis Tools -->
        <div class="visualization-section">
            <div class="chart-title">Analysis Tools & Export</div>
            <div class="chart-description">
                Export your analysis and generate comprehensive EPV reports for investment decisions.
            </div>
            <div class="controls">
                <button class="export-btn" onclick="exportAllCharts()">Export All Charts</button>
                <button class="export-btn" onclick="generateReport()">Generate PDF Report</button>
                <button class="export-btn" onclick="exportToExcel()">Export to Excel</button>
                <button class="export-btn" onclick="saveScenario()">Save Scenario</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced sample data for all visualizations
        const sampleData = {
            earnings: {
                years: ['2015', '2016', '2017', '2018', '2019', '2020', '2021', '2022', '2023', '2024'],
                ebit: [320, 380, 420, 350, 450, 280, 520, 480, 410, 430],
                events: [
                    { year: '2020', label: 'COVID-19 Impact', value: 280 },
                    { year: '2021', label: 'Recovery Surge', value: 520 }
                ]
            },
            capex: {
                years: ['2020', '2021', '2022', '2023', '2024'],
                totalCapex: [150, 180, 165, 190, 175],
                maintenanceCapex: [120, 130, 125, 135, 130]
            },
            epvData: {
                epvValue: 95,
                dcfScenarios: [
                    { growth: 0, value: 75 },
                    { growth: 2, value: 88 },
                    { growth: 4, value: 105 },
                    { growth: 6, value: 128 }
                ]
            },
            waterfallData: [
                { label: 'Normalized EBIT', value: 420, cumulative: 420, type: 'start' },
                { label: 'Less: Taxes (25%)', value: -105, cumulative: 315, type: 'negative' },
                { label: 'Less: Maintenance Capex', value: -130, cumulative: 185, type: 'negative' },
                { label: 'Add: Depreciation', value: 85, cumulative: 270, type: 'positive' },
                { label: 'Operating Cash Flow', value: 0, cumulative: 270, type: 'subtotal' },
                { label: 'Divide by WACC (9%)', value: 0, cumulative: 3000, type: 'calculation' },
                { label: 'Divide by Shares (35M)', value: 0, cumulative: 85.7, type: 'final' }
            ],
            historicalData: {
                dates: ['2020-01', '2020-07', '2021-01', '2021-07', '2022-01', '2022-07', '2023-01', '2023-07', '2024-01', '2024-07'],
                epvValues: [88, 92, 94, 96, 93, 89, 95, 97, 98, 95],
                marketPrices: [75, 85, 105, 88, 92, 78, 85, 102, 89, 85],
                marginOfSafety: [17.3, 8.2, -10.5, 9.1, 1.1, 14.1, 11.8, -4.9, 10.1, 11.8]
            },
            peerData: [
                { name: 'Target Company', epv: 95.2, price: 85.0, margin: 12.0, roic: 15.2, debtEquity: 0.3, rating: 'BUY' },
                { name: 'Competitor A', epv: 78.5, price: 82.1, margin: -4.4, roic: 12.8, debtEquity: 0.5, rating: 'HOLD' },
                { name: 'Competitor B', epv: 112.3, price: 98.7, margin: 13.8, roic: 18.1, debtEquity: 0.2, rating: 'BUY' },
                { name: 'Competitor C', epv: 65.8, price: 71.2, margin: -7.6, roic: 9.4, debtEquity: 0.8, rating: 'SELL' },
                { name: 'Competitor D', epv: 89.4, price: 76.3, margin: 17.2, roic: 16.7, debtEquity: 0.4, rating: 'BUY' }
            ]
        };

        // Global chart references
        let priceComparisonChart, marginChart, monteCarloChart, peerChart;

        // Initialize all charts
        document.addEventListener('DOMContentLoaded', function() {
            initEarningsChart();
            initCapexChart();
            initScenarioChart();
            initWACCChart();
            initWaterfallChart();
            initPriceComparisonChart();
            initMarginChart();
            initMonteCarloChart();
            initPeerComparisonChart();
            initHeatMap();
            populatePeerTable();
            
            // Add chart.js plugins
            Chart.register(window['chartjs-adapter-date-fns']);
        });

        // 1. Normalized Earnings Bar Chart
        function initEarningsChart() {
            const ctx = document.getElementById('earningsChart').getContext('2d');
            const avgEBIT = sampleData.earnings.ebit.reduce((a, b) => a + b, 0) / sampleData.earnings.ebit.length;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleData.earnings.years,
                    datasets: [{
                        label: 'Annual EBIT ($M)',
                        data: sampleData.earnings.ebit,
                        backgroundColor: sampleData.earnings.ebit.map(value => 
                            value > avgEBIT ? '#2ecc71' : value < avgEBIT * 0.8 ? '#e74c3c' : '#3498db'
                        ),
                        borderColor: '#2c3e50',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const event = sampleData.earnings.events.find(e => e.year === context.label);
                                    return event ? `Event: ${event.label}` : '';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                averageLine: {
                                    type: 'line',
                                    yMin: avgEBIT,
                                    yMax: avgEBIT,
                                    borderColor: '#e74c3c',
                                    borderWidth: 3,
                                    borderDash: [5, 5],
                                    label: {
                                        content: `Normalized Average: $${avgEBIT.toFixed(0)}M`,
                                        enabled: true,
                                        position: 'end'
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'EBIT ($ Millions)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Fiscal Year'
                            }
                        }
                    }
                }
            });
        }

        // 2. Maintenance Capex Breakdown Chart
        function initCapexChart() {
            const ctx = document.getElementById('capexChart').getContext('2d');
            const avgMaintenance = sampleData.capex.maintenanceCapex.reduce((a, b) => a + b, 0) / sampleData.capex.maintenanceCapex.length;
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sampleData.capex.years,
                    datasets: [{
                        label: 'Maintenance Capex ($M)',
                        data: sampleData.capex.maintenanceCapex,
                        backgroundColor: '#2ecc71',
                        stack: 'capex'
                    }, {
                        label: 'Growth Capex ($M)',
                        data: sampleData.capex.totalCapex.map((total, i) => total - sampleData.capex.maintenanceCapex[i]),
                        backgroundColor: '#9b59b6',
                        stack: 'capex'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                footer: function(tooltipItems) {
                                    const yearIndex = tooltipItems[0].dataIndex;
                                    const total = sampleData.capex.totalCapex[yearIndex];
                                    return `Total Capex: $${total}M`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Capital Expenditure ($ Millions)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Year'
                            }
                        }
                    }
                }
            });
        }

        // 3. EPV vs DCF Scenario Analysis
        let scenarioChart;
        function initScenarioChart() {
            const ctx = document.getElementById('scenarioChart').getContext('2d');
            
            scenarioChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['EPV', '0% Growth DCF'],
                    datasets: [{
                        label: 'Valuation per Share ($)',
                        data: [sampleData.epvData.epvValue, sampleData.epvData.dcfScenarios[0].value],
                        backgroundColor: ['#34495e', '#3498db'],
                        borderColor: ['#2c3e50', '#2980b9'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    if (context.label === 'EPV') {
                                        return 'Stable, conservative valuation';
                                    } else {
                                        return 'Sensitive to growth assumptions';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Valuation per Share ($)'
                            }
                        }
                    }
                }
            });
        }

        function updateScenario(growthRate) {
            // Update button states
            document.querySelectorAll('.scenario-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            if (growthRate === 'all') {
                // Show all scenarios
                scenarioChart.data.labels = ['EPV', '0% DCF', '2% DCF', '4% DCF', '6% DCF'];
                scenarioChart.data.datasets[0].data = [
                    sampleData.epvData.epvValue,
                    ...sampleData.epvData.dcfScenarios.map(s => s.value)
                ];
                scenarioChart.data.datasets[0].backgroundColor = [
                    '#34495e', '#3498db', '#2ecc71', '#f39c12', '#e74c3c'
                ];
            } else {
                // Show specific scenario
                const dcfScenario = sampleData.epvData.dcfScenarios.find(s => s.growth === growthRate);
                scenarioChart.data.labels = ['EPV', `${growthRate}% Growth DCF`];
                scenarioChart.data.datasets[0].data = [sampleData.epvData.epvValue, dcfScenario.value];
                scenarioChart.data.datasets[0].backgroundColor = ['#34495e', '#3498db'];
            }
            
            scenarioChart.update();
        }

        // 4. WACC Sensitivity Line Chart
        let waccChart;
        function initWACCChart() {
            const ctx = document.getElementById('waccChart').getContext('2d');
            const waccValues = [];
            const epvValues = [];
            
            for (let wacc = 6; wacc <= 12; wacc += 0.5) {
                waccValues.push(wacc);
                epvValues.push(calculateEPV(270, wacc)); // Using operating cash flow from waterfall
            }
            
            waccChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: waccValues.map(w => w + '%'),
                    datasets: [{
                        label: 'EPV per Share ($)',
                        data: epvValues,
                        borderColor: '#3498db',
                        backgroundColor: 'rgba(52, 152, 219, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 5,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                afterLabel: function(context) {
                                    const currentPrice = parseFloat(document.getElementById('currentPriceValue').textContent);
                                    const epvValue = context.parsed.y;
                                    const marginOfSafety = ((epvValue - currentPrice) / currentPrice * 100).toFixed(1);
                                    return `Margin of Safety: ${marginOfSafety}%`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'EPV per Share ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'WACC (%)'
                            }
                        }
                    }
                }
            });
            
            updateWACCChart();
        }

        function updateWACCChart() {
            const waccSlider = document.getElementById('waccSlider');
            const currentPriceSlider = document.getElementById('currentPrice');
            const waccValue = parseFloat(waccSlider.value);
            const currentPrice = parseFloat(currentPriceSlider.value);
            
            document.getElementById('waccValue').textContent = waccValue.toFixed(1) + '%';
            document.getElementById('currentPriceValue').textContent = currentPrice.toFixed(2);
            
            // Add current price line
            waccChart.options.plugins.annotation = {
                annotations: {
                    priceLine: {
                        type: 'line',
                        yMin: currentPrice,
                        yMax: currentPrice,
                        borderColor: '#e74c3c',
                        borderWidth: 2,
                        borderDash: [5, 5],
                        label: {
                            content: `Current Price: $${currentPrice.toFixed(2)}`,
                            enabled: true,
                            position: 'end'
                        }
                    }
                }
            };
            
            waccChart.update();
        }

        function calculateEPV(operatingCashFlow, wacc) {
            const shares = 35; // 35 million shares
            return (operatingCashFlow / (wacc / 100)) / shares;
        }

        // 5. EPV Component Waterfall Chart
        function initWaterfallChart() {
            const svg = d3.select('#waterfallChart');
            const container = document.querySelector('.waterfall-container');
            const margin = { top: 40, right: 60, bottom: 80, left: 80 };
            const width = container.clientWidth - margin.left - margin.right;
            const height = container.clientHeight - margin.top - margin.bottom;
            
            svg.attr('width', width + margin.left + margin.right)
               .attr('height', height + margin.top + margin.bottom);
            
            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);
            
            const data = sampleData.waterfallData;
            
            // Simplified waterfall data for visualization
            const processedData = [
                { label: 'EBIT', value: 420, color: '#3498db' },
                { label: 'Taxes', value: -105, color: '#e74c3c' },
                { label: 'Maint. Capex', value: -130, color: '#e74c3c' },
                { label: 'Depreciation', value: 85, color: '#2ecc71' },
                { label: 'Cash Flow', value: 270, color: '#f39c12' }
            ];
            
            const xScale = d3.scaleBand()
                .domain(processedData.map(d => d.label))
                .range([0, width])
                .padding(0.3);
            
            const yScale = d3.scaleLinear()
                .domain([0, 450])
                .range([height, 0]);
            
            // Create bars
            g.selectAll('.bar')
                .data(processedData)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', d => xScale(d.label))
                .attr('y', d => d.value > 0 ? yScale(d.value) : yScale(0))
                .attr('width', xScale.bandwidth())
                .attr('height', d => Math.abs(yScale(0) - yScale(Math.abs(d.value))))
                .attr('fill', d => d.color)
                .attr('stroke', '#2c3e50')
                .attr('stroke-width', 1);
            
            // Add value labels
            g.selectAll('.value-label')
                .data(processedData)
                .enter().append('text')
                .attr('class', 'value-label')
                .attr('x', d => xScale(d.label) + xScale.bandwidth() / 2)
                .attr('y', d => d.value > 0 ? yScale(d.value) - 5 : yScale(0) + 15)
                .attr('text-anchor', 'middle')
                .attr('font-size', '12px')
                .attr('font-weight', 'bold')
                .text(d => '$' + Math.abs(d.value) + 'M');
            
            // Add axes
            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(xScale));
            
                         g.append('g')
                 .call(d3.axisLeft(yScale));
         }

         // 6. Historical EPV vs Market Price Analysis
         function initPriceComparisonChart() {
             const ctx = document.getElementById('priceComparisonChart').getContext('2d');
             
             priceComparisonChart = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: sampleData.historicalData.dates,
                     datasets: [{
                         label: 'EPV per Share',
                         data: sampleData.historicalData.epvValues,
                         borderColor: '#2ecc71',
                         backgroundColor: 'rgba(46, 204, 113, 0.1)',
                         fill: false,
                         tension: 0.4,
                         pointRadius: 6,
                         pointHoverRadius: 8,
                         borderWidth: 3
                     }, {
                         label: 'Market Price',
                         data: sampleData.historicalData.marketPrices,
                         borderColor: '#e74c3c',
                         backgroundColor: 'rgba(231, 76, 60, 0.1)',
                         fill: false,
                         tension: 0.4,
                         pointRadius: 6,
                         pointHoverRadius: 8,
                         borderWidth: 3
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     interaction: {
                         intersect: false,
                         mode: 'index'
                     },
                     plugins: {
                         tooltip: {
                             callbacks: {
                                 afterBody: function(tooltipItems) {
                                     const index = tooltipItems[0].dataIndex;
                                     const epv = sampleData.historicalData.epvValues[index];
                                     const price = sampleData.historicalData.marketPrices[index];
                                     const margin = ((epv - price) / price * 100).toFixed(1);
                                     return `Margin of Safety: ${margin}%`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             title: {
                                 display: true,
                                 text: 'Price per Share ($)'
                             },
                             grid: {
                                 color: 'rgba(0,0,0,0.1)'
                             }
                         },
                         x: {
                             title: {
                                 display: true,
                                 text: 'Date'
                             },
                             grid: {
                                 color: 'rgba(0,0,0,0.1)'
                             }
                         }
                     },
                     animation: {
                         duration: 2000,
                         easing: 'easeInOutQuart'
                     }
                 }
             });
         }

         function initMarginChart() {
             const ctx = document.getElementById('marginChart').getContext('2d');
             
             marginChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: sampleData.historicalData.dates,
                     datasets: [{
                         label: 'Margin of Safety (%)',
                         data: sampleData.historicalData.marginOfSafety,
                         backgroundColor: sampleData.historicalData.marginOfSafety.map(value => 
                             value > 10 ? '#27ae60' : value > 0 ? '#f39c12' : '#e74c3c'
                         ),
                         borderColor: '#2c3e50',
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     const value = context.parsed.y;
                                     let interpretation = '';
                                     if (value > 15) interpretation = ' (Excellent buying opportunity)';
                                     else if (value > 5) interpretation = ' (Good margin)';
                                     else if (value > 0) interpretation = ' (Minimal margin)';
                                     else interpretation = ' (Overvalued)';
                                     return `${context.dataset.label}: ${value}%${interpretation}`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             title: {
                                 display: true,
                                 text: 'Margin of Safety (%)'
                             },
                             grid: {
                                 color: function(context) {
                                     return context.tick.value === 0 ? '#000' : 'rgba(0,0,0,0.1)';
                                 }
                             }
                         },
                         x: {
                             title: {
                                 display: true,
                                 text: 'Date'
                             }
                         }
                     }
                 }
             });
         }

         // 7. Monte Carlo Simulation
         function initMonteCarloChart() {
             const ctx = document.getElementById('monteCarloChart').getContext('2d');
             
             // Generate initial histogram data
             const simulationResults = generateMonteCarloData(5000);
             
             monteCarloChart = new Chart(ctx, {
                 type: 'bar',
                 data: {
                     labels: simulationResults.bins,
                     datasets: [{
                         label: 'Frequency',
                         data: simulationResults.frequencies,
                         backgroundColor: 'rgba(52, 152, 219, 0.7)',
                         borderColor: '#3498db',
                         borderWidth: 1
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         tooltip: {
                             callbacks: {
                                 title: function(tooltipItems) {
                                     const bin = tooltipItems[0].label;
                                     return `EPV Range: $${bin}`;
                                 },
                                 label: function(context) {
                                     return `Frequency: ${context.parsed.y} simulations`;
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             title: {
                                 display: true,
                                 text: 'Number of Simulations'
                             }
                         },
                         x: {
                             title: {
                                 display: true,
                                 text: 'EPV per Share ($)'
                             }
                         }
                     }
                 }
             });
         }

         function generateMonteCarloData(numSimulations) {
             const results = [];
             
             // Base parameters with variations
             const baseEBIT = 420;
             const baseWACC = 0.09;
             const baseShares = 35;
             
             for (let i = 0; i < numSimulations; i++) {
                 // Add random variations (normal distribution approximation)
                 const ebitVariation = (Math.random() + Math.random() + Math.random() + Math.random() - 2) * 50;
                 const waccVariation = (Math.random() + Math.random() + Math.random() + Math.random() - 2) * 0.02;
                 const capexVariation = (Math.random() + Math.random() + Math.random() + Math.random() - 2) * 20;
                 
                 const adjustedEBIT = baseEBIT + ebitVariation;
                 const adjustedWACC = Math.max(0.05, baseWACC + waccVariation);
                 const adjustedCapex = 130 + capexVariation;
                 
                 // Calculate EPV
                 const operatingCashFlow = adjustedEBIT * 0.75 - adjustedCapex + 85; // simplified
                 const enterpriseValue = operatingCashFlow / adjustedWACC;
                 const epvPerShare = enterpriseValue / baseShares;
                 
                 results.push(epvPerShare);
             }
             
             // Create histogram bins
             const min = Math.min(...results);
             const max = Math.max(...results);
             const binCount = 20;
             const binWidth = (max - min) / binCount;
             const bins = [];
             const frequencies = new Array(binCount).fill(0);
             
             for (let i = 0; i < binCount; i++) {
                 bins.push((min + i * binWidth).toFixed(0));
             }
             
             results.forEach(value => {
                 const binIndex = Math.min(Math.floor((value - min) / binWidth), binCount - 1);
                 frequencies[binIndex]++;
             });
             
             // Update metrics
             results.sort((a, b) => a - b);
             document.getElementById('mcMedian').textContent = '$' + results[Math.floor(results.length * 0.5)].toFixed(2);
             document.getElementById('mc25th').textContent = '$' + results[Math.floor(results.length * 0.25)].toFixed(2);
             document.getElementById('mc75th').textContent = '$' + results[Math.floor(results.length * 0.75)].toFixed(2);
             
             const currentPrice = 85;
             const upsideProbability = results.filter(v => v > currentPrice).length / results.length * 100;
             document.getElementById('mcUpside').textContent = upsideProbability.toFixed(0) + '%';
             
             return { bins, frequencies, results };
         }

         // 8. Peer Comparison Chart
         function initPeerComparisonChart() {
             const ctx = document.getElementById('peerComparisonChart').getContext('2d');
             
             peerChart = new Chart(ctx, {
                 type: 'scatter',
                 data: {
                     datasets: [{
                         label: 'EPV vs Market Price',
                         data: sampleData.peerData.map(peer => ({
                             x: peer.price,
                             y: peer.epv,
                             label: peer.name,
                             rating: peer.rating
                         })),
                         backgroundColor: function(context) {
                             const rating = context.parsed.rating;
                             return rating === 'BUY' ? '#27ae60' : 
                                    rating === 'HOLD' ? '#f39c12' : '#e74c3c';
                         },
                         borderColor: '#2c3e50',
                         pointRadius: 8,
                         pointHoverRadius: 12
                     }]
                 },
                 options: {
                     responsive: true,
                     maintainAspectRatio: false,
                     plugins: {
                         tooltip: {
                             callbacks: {
                                 title: function(tooltipItems) {
                                     return tooltipItems[0].raw.label;
                                 },
                                 label: function(context) {
                                     const data = context.raw;
                                     const margin = ((data.y - data.x) / data.x * 100).toFixed(1);
                                     return [
                                         `Market Price: $${data.x}`,
                                         `EPV: $${data.y}`,
                                         `Margin of Safety: ${margin}%`,
                                         `Rating: ${data.rating}`
                                     ];
                                 }
                             }
                         }
                     },
                     scales: {
                         y: {
                             title: {
                                 display: true,
                                 text: 'EPV per Share ($)'
                             }
                         },
                         x: {
                             title: {
                                 display: true,
                                 text: 'Market Price per Share ($)'
                             }
                         }
                     }
                 }
             });
             
             // Add diagonal line for EPV = Market Price
             const minValue = Math.min(...sampleData.peerData.map(p => Math.min(p.epv, p.price)));
             const maxValue = Math.max(...sampleData.peerData.map(p => Math.max(p.epv, p.price)));
             
             peerChart.data.datasets.push({
                 type: 'line',
                 label: 'Fair Value Line',
                 data: [{x: minValue, y: minValue}, {x: maxValue, y: maxValue}],
                 borderColor: '#95a5a6',
                 borderDash: [5, 5],
                 pointRadius: 0,
                 fill: false
             });
             
             peerChart.update();
         }

         function populatePeerTable() {
             const tbody = document.getElementById('peerTableBody');
             tbody.innerHTML = '';
             
             sampleData.peerData.forEach(peer => {
                 const row = document.createElement('tr');
                 const marginClass = peer.margin > 10 ? 'positive' : peer.margin > 0 ? 'neutral' : 'negative';
                 const ratingClass = peer.rating === 'BUY' ? 'positive' : peer.rating === 'HOLD' ? 'neutral' : 'negative';
                 
                 row.innerHTML = `
                     <td><strong>${peer.name}</strong></td>
                     <td>$${peer.epv.toFixed(2)}</td>
                     <td>$${peer.price.toFixed(2)}</td>
                     <td class="${marginClass}">${peer.margin.toFixed(1)}%</td>
                     <td>${peer.roic.toFixed(1)}%</td>
                     <td>${peer.debtEquity.toFixed(1)}</td>
                     <td class="${ratingClass}"><strong>${peer.rating}</strong></td>
                 `;
                 tbody.appendChild(row);
             });
         }

         // 9. Sensitivity Heat Map
         function initHeatMap() {
             updateHeatMap('wacc-earnings');
         }

         function updateHeatMap(type) {
             const svg = d3.select('#heatMapChart');
             svg.selectAll("*").remove();
             
             const container = svg.node().parentElement;
             const margin = { top: 40, right: 100, bottom: 60, left: 80 };
             const width = container.clientWidth - margin.left - margin.right;
             const height = 400 - margin.top - margin.bottom;
             
             svg.attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);
             
             const g = svg.append('g')
                 .attr('transform', `translate(${margin.left},${margin.top})`);
             
             let data, xValues, yValues, xLabel, yLabel;
             
             if (type === 'wacc-earnings') {
                 xValues = [6, 7, 8, 9, 10, 11, 12];
                 yValues = [350, 375, 400, 425, 450, 475, 500];
                 xLabel = 'WACC (%)';
                 yLabel = 'Normalized EBIT ($M)';
                 data = generateHeatMapData(xValues, yValues, (wacc, ebit) => {
                     const ocf = ebit * 0.75 - 130 + 85;
                     return ocf / (wacc / 100) / 35;
                 });
             } else if (type === 'wacc-capex') {
                 xValues = [6, 7, 8, 9, 10, 11, 12];
                 yValues = [100, 115, 130, 145, 160, 175, 190];
                 xLabel = 'WACC (%)';
                 yLabel = 'Maintenance Capex ($M)';
                 data = generateHeatMapData(xValues, yValues, (wacc, capex) => {
                     const ocf = 420 * 0.75 - capex + 85;
                     return ocf / (wacc / 100) / 35;
                 });
             } else {
                 xValues = [350, 375, 400, 425, 450, 475, 500];
                 yValues = [100, 115, 130, 145, 160, 175, 190];
                 xLabel = 'Normalized EBIT ($M)';
                 yLabel = 'Maintenance Capex ($M)';
                 data = generateHeatMapData(xValues, yValues, (ebit, capex) => {
                     const ocf = ebit * 0.75 - capex + 85;
                     return ocf / 0.09 / 35;
                 });
             }
             
             const xScale = d3.scaleBand()
                 .domain(xValues)
                 .range([0, width])
                 .padding(0.05);
             
             const yScale = d3.scaleBand()
                 .domain(yValues)
                 .range([height, 0])
                 .padding(0.05);
             
             const colorScale = d3.scaleSequential(d3.interpolateRdYlGn)
                 .domain([d3.min(data, d => d.value), d3.max(data, d => d.value)]);
             
             // Create cells
             g.selectAll('.cell')
                 .data(data)
                 .enter().append('rect')
                 .attr('class', 'cell')
                 .attr('x', d => xScale(d.x))
                 .attr('y', d => yScale(d.y))
                 .attr('width', xScale.bandwidth())
                 .attr('height', yScale.bandwidth())
                 .attr('fill', d => colorScale(d.value))
                 .attr('stroke', '#fff')
                 .attr('stroke-width', 1)
                 .on('mouseover', function(event, d) {
                     d3.select(this).attr('stroke-width', 3);
                     // Add tooltip logic here
                 })
                 .on('mouseout', function() {
                     d3.select(this).attr('stroke-width', 1);
                 });
             
             // Add value labels
             g.selectAll('.cell-label')
                 .data(data)
                 .enter().append('text')
                 .attr('class', 'cell-label')
                 .attr('x', d => xScale(d.x) + xScale.bandwidth() / 2)
                 .attr('y', d => yScale(d.y) + yScale.bandwidth() / 2)
                 .attr('text-anchor', 'middle')
                 .attr('dominant-baseline', 'middle')
                 .attr('font-size', '10px')
                 .attr('font-weight', 'bold')
                 .attr('fill', d => d.value > 85 ? '#000' : '#fff')
                 .text(d => '$' + d.value.toFixed(0));
             
             // Add axes
             g.append('g')
                 .attr('transform', `translate(0,${height})`)
                 .call(d3.axisBottom(xScale));
             
             g.append('g')
                 .call(d3.axisLeft(yScale));
             
             // Add axis labels
             g.append('text')
                 .attr('transform', `translate(${width/2}, ${height + 45})`)
                 .style('text-anchor', 'middle')
                 .style('font-weight', 'bold')
                 .text(xLabel);
             
             g.append('text')
                 .attr('transform', 'rotate(-90)')
                 .attr('y', 0 - margin.left + 15)
                 .attr('x', 0 - (height / 2))
                 .style('text-anchor', 'middle')
                 .style('font-weight', 'bold')
                 .text(yLabel);
         }

         function generateHeatMapData(xValues, yValues, calculator) {
             const data = [];
             xValues.forEach(x => {
                 yValues.forEach(y => {
                     data.push({
                         x: x,
                         y: y,
                         value: calculator(x, y)
                     });
                 });
             });
             return data;
         }

         // Tab switching functionality
         function switchTab(tabId, contentId) {
             // Remove active class from all tabs and content
             document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
             document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
             
             // Add active class to selected tab and content
             event.target.classList.add('active');
             document.getElementById(contentId).classList.add('active');
         }

         // Enhanced interactive functions
         function updateSimulations() {
             const value = document.getElementById('simulations').value;
             document.getElementById('simValue').textContent = parseInt(value).toLocaleString();
         }

         function runMonteCarloSimulation() {
             const numSims = parseInt(document.getElementById('simulations').value);
             const simulationResults = generateMonteCarloData(numSims);
             
             monteCarloChart.data.labels = simulationResults.bins;
             monteCarloChart.data.datasets[0].data = simulationResults.frequencies;
             monteCarloChart.update('active');
         }

         function animateWaterfall() {
             // Add animation to waterfall chart
             const bars = d3.selectAll('#waterfallChart .bar');
             bars.transition()
                 .duration(1000)
                 .delay((d, i) => i * 200)
                 .attr('opacity', 0.3)
                 .transition()
                 .duration(500)
                 .attr('opacity', 1);
         }

         // Export functions
         function exportChart(chartType) {
             let canvas;
             switch(chartType) {
                 case 'waterfall':
                     // Convert SVG to canvas for export
                     alert('Waterfall chart export functionality would be implemented here');
                     break;
                 case 'montecarlo':
                     canvas = document.getElementById('monteCarloChart');
                     break;
                 default:
                     alert('Export functionality for ' + chartType + ' would be implemented here');
                     return;
             }
             
             if (canvas) {
                 const url = canvas.toDataURL('image/png');
                 const link = document.createElement('a');
                 link.download = chartType + '_chart.png';
                 link.href = url;
                 link.click();
             }
         }

         function exportAllCharts() {
             alert('Export all charts functionality would create a comprehensive report with all visualizations');
         }

         function generateReport() {
             alert('PDF report generation would compile all analysis into a professional investment report');
         }

         function exportToExcel() {
             alert('Excel export would include all data tables and calculations for further analysis');
         }

         function saveScenario() {
             alert('Save scenario functionality would store current assumptions and results');
         }
    </script>
</body>
</html> 