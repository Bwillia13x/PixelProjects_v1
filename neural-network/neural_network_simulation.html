<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced LLM Neural Network Simulation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .neuron {
            transition: all 0.3s ease-in-out;
            box-shadow: 0 0 5px rgba(255, 255, 255, 0);
            z-index: 10;
            position: relative;
        }
        .neuron.active {
            transform: scale(1.3);
            box-shadow: 0 0 30px currentColor;
        }
        .neuron.attention {
            animation: pulse 1s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); opacity: 0.8; }
            50% { transform: scale(1.4); opacity: 1; }
            100% { transform: scale(1); opacity: 0.8; }
        }
        .line {
            stroke-width: 1.5;
            stroke: #4b5563;
            transition: all 0.3s ease-in-out;
            z-index: 1;
            opacity: 0.3;
        }
        .line.active {
            stroke-width: 3;
            opacity: 1;
        }
        #brain-visualization {
            background-image: radial-gradient(#374151 1px, transparent 0);
            background-size: 20px 20px;
        }
        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            pointer-events: none;
            z-index: 20;
            opacity: 0;
        }
        .token-box {
            display: inline-block;
            padding: 4px 8px;
            margin: 2px;
            border-radius: 6px;
            background-color: rgba(251, 191, 36, 0.2);
            border: 1px solid #fbbf24;
            font-family: monospace;
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        .token-box.active {
            background-color: rgba(251, 191, 36, 0.5);
            transform: scale(1.1);
        }
        .metric-card {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            padding: 1rem;
            border-radius: 0.75rem;
            transition: all 0.3s ease;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        .heatmap-cell {
            transition: all 0.2s ease;
        }
        .prompt-template {
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .prompt-template:hover {
            background-color: rgba(251, 191, 36, 0.1);
            border-color: #fbbf24;
        }
        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
            animation: blink 2s infinite;
        }
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        .layer-label {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
    </style>
</head>
<body class="bg-gray-900 text-white antialiased">
    <div class="min-h-screen flex flex-col p-4">
        <!-- Header with Controls -->
        <header class="w-full max-w-7xl mx-auto mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold tracking-tight text-transparent bg-clip-text bg-gradient-to-r from-amber-400 via-orange-500 to-red-500">
                        Advanced Neural Network Simulation
                    </h1>
                    <p class="mt-2 text-lg text-gray-400">Experience how modern LLMs process and generate text</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="status-indicator bg-green-500"></div>
                    <span class="text-sm text-gray-400">System Active</span>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex-1 w-full max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-4 gap-6">
            <!-- Left Panel - Input & Controls -->
            <div class="xl:col-span-1 space-y-4">
                <!-- Input Section -->
                <div class="bg-gray-800 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center font-bold">1</div>
                            <h2 class="text-xl font-semibold">Input</h2>
                        </div>
                        <span id="token-count" class="text-xs text-gray-500">0 tokens</span>
                    </div>
                    <textarea id="user-input" class="w-full h-32 bg-gray-700 rounded-lg p-3 focus:ring-2 focus:ring-amber-500 focus:outline-none transition resize-none" 
                        placeholder="Ask a question or type a prompt..."></textarea>
                    
                    <!-- Model Controls -->
                    <div class="space-y-3">
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Temperature (Creativity)</label>
                            <input type="range" id="temperature" min="0" max="1" step="0.1" value="0.7" 
                                class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-gray-500 mt-1">
                                <span>Precise</span>
                                <span id="temp-value">0.7</span>
                                <span>Creative</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="text-xs text-gray-400 mb-1 block">Model</label>
                            <select id="model-select" class="w-full bg-gray-700 rounded-lg p-2 text-sm focus:ring-2 focus:ring-amber-500 focus:outline-none">
                                <option value="gemini-2.0-flash">Gemini 2.0 Flash</option>
                                <option value="gemini-1.5-pro">Gemini 1.5 Pro</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash</option>
                            </select>
                        </div>
                    </div>
                    
                    <button id="generate-btn" class="w-full bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-gray-900 font-bold py-3 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 shadow-lg">
                        ‚ú® Generate Response
                    </button>
                    
                    <!-- Prompt Templates -->
                    <div class="mt-4">
                        <p class="text-xs text-gray-400 mb-2">Quick Prompts:</p>
                        <div class="flex flex-wrap gap-2">
                            <button class="prompt-template text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full border border-gray-600">
                                Explain quantum computing
                            </button>
                            <button class="prompt-template text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full border border-gray-600">
                                Write a haiku
                            </button>
                            <button class="prompt-template text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-full border border-gray-600">
                                Code a function
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Metrics Dashboard -->
                <div class="bg-gray-800 rounded-2xl p-4 space-y-3">
                    <h3 class="text-lg font-semibold text-gray-300">Performance Metrics</h3>
                    
                    <div class="metric-card">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Processing Time</span>
                            <span id="processing-time" class="text-xl font-bold text-amber-400">0ms</span>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Active Neurons</span>
                            <span id="active-neurons" class="text-xl font-bold text-green-400">0</span>
                        </div>
                    </div>
                    
                    <div class="metric-card">
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">Response Tokens</span>
                            <span id="response-tokens" class="text-xl font-bold text-blue-400">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Neural Network Visualization -->
            <div class="xl:col-span-2 bg-gray-800 rounded-2xl p-6 relative overflow-hidden">
                <div class="flex items-center justify-between mb-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-green-500 flex items-center justify-center font-bold">2</div>
                        <h2 class="text-xl font-semibold">Neural Processing</h2>
                    </div>
                    <div class="flex gap-2">
                        <button id="view-toggle" class="text-xs bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded-lg transition">
                            Switch View
                        </button>
                    </div>
                </div>
                
                <!-- Neural Network Visualization -->
                <div id="brain-visualization" class="relative w-full h-[500px] rounded-lg">
                    <svg id="lines-svg" class="absolute top-0 left-0 w-full h-full" width="100%" height="100%"></svg>
                    <!-- Attention Visualization Layer -->
                    <div id="attention-layer" class="absolute top-0 left-0 w-full h-full pointer-events-none opacity-0 transition-opacity duration-500"></div>
                </div>
                
                <!-- Token Visualization -->
                <div id="token-visualization" class="mt-4 p-4 bg-gray-700 rounded-lg min-h-[100px] hidden">
                    <h4 class="text-sm font-semibold text-gray-400 mb-2">Token Stream</h4>
                    <div id="token-stream" class="flex flex-wrap gap-2"></div>
                </div>
            </div>

            <!-- Right Panel - Output & Insights -->
            <div class="xl:col-span-1 space-y-4">
                <!-- Output Section -->
                <div class="bg-gray-800 rounded-2xl p-6 space-y-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 rounded-full bg-purple-500 flex items-center justify-center font-bold">3</div>
                        <h2 class="text-xl font-semibold">Output</h2>
                        <span class="text-xs bg-blue-600 px-2 py-1 rounded-full">Live AI</span>
                    </div>
                    <div id="output-area" class="w-full min-h-[200px] max-h-[400px] overflow-y-auto bg-gray-700 rounded-lg p-4 text-base leading-relaxed">
                        <span class="text-gray-500">Waiting for input...</span>
                    </div>
                    <div class="flex gap-2">
                        <button id="copy-btn" class="flex-1 text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg transition">
                            üìã Copy
                        </button>
                        <button id="clear-btn" class="flex-1 text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded-lg transition">
                            üóëÔ∏è Clear
                        </button>
                    </div>
                </div>

                <!-- Process Explanation -->
                <div class="bg-gradient-to-br from-gray-800 to-gray-700 rounded-2xl p-6 border border-gray-600">
                    <h3 class="text-lg font-bold text-amber-400 mb-3 flex items-center">
                        <span class="mr-2">üí°</span> What's Happening?
                    </h3>
                    <div id="explanation-text" class="text-sm text-gray-300 space-y-2">
                        <p>Enter a prompt to see how neural networks process language.</p>
                    </div>
                    
                    <!-- Layer Activity Heatmap -->
                    <div id="heatmap" class="mt-4 p-3 bg-gray-800 rounded-lg hidden">
                        <h4 class="text-xs font-semibold text-gray-400 mb-2">Layer Activity Heatmap</h4>
                        <div id="heatmap-grid" class="grid grid-cols-5 gap-1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- History Panel (Bottom) -->
        <div class="w-full max-w-7xl mx-auto mt-6">
            <div class="bg-gray-800 rounded-2xl p-4">
                <h3 class="text-lg font-semibold mb-3">Conversation History</h3>
                <div id="history" class="flex gap-3 overflow-x-auto pb-2">
                    <div class="text-sm text-gray-500 italic">No previous conversations</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // State Management
            const state = {
                apiKey: "", // Environment provides the key
                currentModel: 'gemini-2.0-flash',
                temperature: 0.7,
                history: [],
                processingStartTime: 0,
                currentView: 'network', // 'network' or 'tokens'
                layerConfig: [5, 12, 8, 12, 5], // More realistic multi-layer architecture
                network: { layers: [], lines: [] }
            };

            // DOM Elements
            const elements = {
                generateBtn: document.getElementById('generate-btn'),
                userInput: document.getElementById('user-input'),
                outputArea: document.getElementById('output-area'),
                explanationText: document.getElementById('explanation-text'),
                brainViz: document.getElementById('brain-visualization'),
                linesSvg: document.getElementById('lines-svg'),
                tokenCount: document.getElementById('token-count'),
                tempSlider: document.getElementById('temperature'),
                tempValue: document.getElementById('temp-value'),
                modelSelect: document.getElementById('model-select'),
                processingTime: document.getElementById('processing-time'),
                activeNeurons: document.getElementById('active-neurons'),
                responseTokens: document.getElementById('response-tokens'),
                viewToggle: document.getElementById('view-toggle'),
                tokenViz: document.getElementById('token-visualization'),
                tokenStream: document.getElementById('token-stream'),
                attentionLayer: document.getElementById('attention-layer'),
                heatmap: document.getElementById('heatmap'),
                heatmapGrid: document.getElementById('heatmap-grid'),
                history: document.getElementById('history'),
                copyBtn: document.getElementById('copy-btn'),
                clearBtn: document.getElementById('clear-btn')
            };

            // Initialize Neural Network Visualization
            function initializeBrain() {
                elements.brainViz.innerHTML = '';
                elements.linesSvg.innerHTML = '';
                state.network = { layers: [], lines: [] };

                const width = elements.brainViz.clientWidth;
                const height = elements.brainViz.clientHeight;
                const layerSpacing = width / (state.layerConfig.length + 1);
                
                // Color gradient for layers
                const layerColors = [
                    '#3b82f6', // blue
                    '#8b5cf6', // violet
                    '#ec4899', // pink
                    '#f59e0b', // amber
                    '#10b981'  // emerald
                ];

                state.layerConfig.forEach((numNeurons, layerIndex) => {
                    const layer = [];
                    const x = layerSpacing * (layerIndex + 1);
                    
                    // Add layer label
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'layer-label';
                    labelDiv.style.left = `${x}px`;
                    labelDiv.textContent = layerIndex === 0 ? 'Input' : 
                                         layerIndex === state.layerConfig.length - 1 ? 'Output' : 
                                         `Hidden ${layerIndex}`;
                    elements.brainViz.appendChild(labelDiv);
                    
                    for (let i = 0; i < numNeurons; i++) {
                        const y = (height / (numNeurons + 1)) * (i + 1);
                        
                        const neuron = document.createElement('div');
                        neuron.className = 'neuron absolute w-4 h-4 rounded-full cursor-pointer';
                        neuron.style.backgroundColor = layerColors[layerIndex];
                        neuron.style.left = `${x - 8}px`;
                        neuron.style.top = `${y - 8}px`;
                        const id = `neuron-${layerIndex}-${i}`;
                        neuron.id = id;
                        
                        // Add hover effect
                        neuron.addEventListener('mouseenter', () => {
                            neuron.style.transform = 'scale(1.5)';
                            highlightConnections(id);
                        });
                        neuron.addEventListener('mouseleave', () => {
                            neuron.style.transform = 'scale(1)';
                            resetHighlights();
                        });
                        
                        elements.brainViz.appendChild(neuron);
                        layer.push({ id, x, y, el: neuron, color: layerColors[layerIndex] });
                    }
                    state.network.layers.push(layer);
                });

                // Create connections with varying opacity based on "weight"
                for (let i = 0; i < state.network.layers.length - 1; i++) {
                    const currentLayer = state.network.layers[i];
                    const nextLayer = state.network.layers[i + 1];
                    
                    currentLayer.forEach(n1 => {
                        // Connect to random subset of next layer (more realistic)
                        const connectionCount = Math.floor(nextLayer.length * 0.7);
                        const connectedNeurons = nextLayer.sort(() => 0.5 - Math.random()).slice(0, connectionCount);
                        
                        connectedNeurons.forEach(n2 => {
                            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                            line.setAttribute('x1', n1.x);
                            line.setAttribute('y1', n1.y);
                            line.setAttribute('x2', n2.x);
                            line.setAttribute('y2', n2.y);
                            const lineId = `line-${n1.id}-${n2.id}`;
                            line.id = lineId;
                            line.classList.add('line');
                            line.style.opacity = Math.random() * 0.3 + 0.1; // Random initial opacity
                            elements.linesSvg.appendChild(line);
                            state.network.lines.push({id: lineId, el: line, from: n1, to: n2});
                        });
                    });
                }
            }

            // Highlight neuron connections
            function highlightConnections(neuronId) {
                state.network.lines.forEach(line => {
                    if (line.from.id === neuronId || line.to.id === neuronId) {
                        line.el.style.stroke = '#fbbf24';
                        line.el.style.opacity = '1';
                    }
                });
            }

            function resetHighlights() {
                state.network.lines.forEach(line => {
                    line.el.style.stroke = '#4b5563';
                    line.el.style.opacity = line.el.dataset.originalOpacity || '0.3';
                });
            }

            // Enhanced particle animation with color
            async function animateParticle(fromNode, toNode, color = '#fbbf24') {
                return new Promise(resolve => {
                    const particle = document.createElement('div');
                    particle.className = 'particle';
                    particle.style.backgroundColor = color;
                    particle.style.boxShadow = `0 0 10px ${color}`;
                    elements.brainViz.appendChild(particle);
                    
                    const duration = 300 + Math.random() * 200;
                    const startTime = Date.now();
                    
                    function frame() {
                        const elapsed = Date.now() - startTime;
                        const progress = Math.min(elapsed / duration, 1);
                        
                        // Bezier curve for more natural movement
                        const easeProgress = 1 - Math.pow(1 - progress, 3);
                        
                        const currentX = fromNode.x + (toNode.x - fromNode.x) * easeProgress;
                        const currentY = fromNode.y + (toNode.y - fromNode.y) * easeProgress;
                        
                        particle.style.left = `${currentX - 3}px`;
                        particle.style.top = `${currentY - 3}px`;
                        particle.style.opacity = 1 - progress * 0.7;
                        particle.style.transform = `scale(${1 + progress * 0.5})`;

                        if (progress < 1) {
                            requestAnimationFrame(frame);
                        } else {
                            particle.remove();
                            resolve();
                        }
                    }
                    requestAnimationFrame(frame);
                });
            }

            // Token counting function
            function countTokens(text) {
                // Simplified token counting (real tokenization is more complex)
                return text.split(/\s+/).filter(word => word.length > 0).length;
            }

            // Update token count in real-time
            elements.userInput.addEventListener('input', () => {
                const tokens = countTokens(elements.userInput.value);
                elements.tokenCount.textContent = `${tokens} tokens`;
            });

            // Temperature slider
            elements.tempSlider.addEventListener('input', (e) => {
                state.temperature = parseFloat(e.target.value);
                elements.tempValue.textContent = state.temperature.toFixed(1);
            });

            // Model selection
            elements.modelSelect.addEventListener('change', (e) => {
                state.currentModel = e.target.value;
            });

            // Prompt templates
            document.querySelectorAll('.prompt-template').forEach(btn => {
                btn.addEventListener('click', () => {
                    elements.userInput.value = btn.textContent.trim();
                    elements.userInput.dispatchEvent(new Event('input'));
                });
            });

            // View toggle
            elements.viewToggle.addEventListener('click', () => {
                if (state.currentView === 'network') {
                    state.currentView = 'tokens';
                    elements.brainViz.style.display = 'none';
                    elements.tokenViz.style.display = 'block';
                    elements.viewToggle.textContent = 'Network View';
                } else {
                    state.currentView = 'network';
                    elements.brainViz.style.display = 'block';
                    elements.tokenViz.style.display = 'none';
                    elements.viewToggle.textContent = 'Token View';
                }
            });

            // Copy button
            elements.copyBtn.addEventListener('click', () => {
                const text = elements.outputArea.textContent;
                navigator.clipboard.writeText(text).then(() => {
                    elements.copyBtn.textContent = '‚úì Copied!';
                    setTimeout(() => {
                        elements.copyBtn.textContent = 'üìã Copy';
                    }, 2000);
                });
            });

            // Clear button
            elements.clearBtn.addEventListener('click', () => {
                elements.outputArea.innerHTML = '<span class="text-gray-500">Waiting for input...</span>';
                elements.responseTokens.textContent = '0';
            });

            // Enhanced Gemini API call with temperature
            async function callGeminiAPI(prompt) {
                elements.explanationText.innerHTML = `
                    <p><strong>üîÑ API Request:</strong> Sending prompt to ${state.currentModel}...</p>
                    <p class="text-xs mt-1">Temperature: ${state.temperature} | Model: ${state.currentModel}</p>
                `;
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${state.currentModel}:generateContent?key=${state.apiKey}`;
                
                const payload = {
                    contents: [{
                        role: "user",
                        parts: [{ text: prompt }]
                    }],
                    generationConfig: {
                        temperature: state.temperature,
                        maxOutputTokens: 1024,
                        topP: 0.95,
                        topK: 40
                    }
                };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        throw new Error(`API Error: ${response.statusText}`);
                    }

                    const result = await response.json();
                    
                    if (result.candidates && result.candidates.length > 0) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        return "I couldn't generate a response. Please try again.";
                    }
                } catch (error) {
                    console.error("API call failed:", error);
                    return `Error: ${error.message}. Please check your API key and connection.`;
                }
            }

            // Token visualization
            function visualizeTokens(text) {
                elements.tokenStream.innerHTML = '';
                const words = text.split(/\s+/);
                
                words.forEach((word, index) => {
                    setTimeout(() => {
                        const tokenBox = document.createElement('span');
                        tokenBox.className = 'token-box';
                        tokenBox.textContent = word;
                        elements.tokenStream.appendChild(tokenBox);
                        
                        setTimeout(() => tokenBox.classList.add('active'), 50);
                        setTimeout(() => tokenBox.classList.remove('active'), 500);
                    }, index * 100);
                });
            }

            // Enhanced response typing with metrics
            async function typeOutResponse(responseText) {
                elements.explanationText.innerHTML = `
                    <p><strong>üìù Decoding:</strong> Converting neural activations back to text...</p>
                    <p class="text-xs mt-1">The model generates one token at a time, predicting the most likely next word.</p>
                `;
                
                const words = responseText.split(' ');
                elements.outputArea.textContent = '';
                elements.responseTokens.textContent = '0';
                
                if (state.currentView === 'tokens') {
                    visualizeTokens(responseText);
                }
                
                for (let i = 0; i < words.length; i++) {
                    elements.outputArea.textContent += words[i] + ' ';
                    elements.responseTokens.textContent = (i + 1).toString();
                    
                    // Highlight random output neurons
                    const outputLayer = state.network.layers[state.network.layers.length - 1];
                    const activeNeurons = Math.floor(Math.random() * 3) + 1;
                    
                    for (let j = 0; j < activeNeurons; j++) {
                        const neuron = outputLayer[Math.floor(Math.random() * outputLayer.length)];
                        neuron.el.classList.add('active');
                        neuron.el.style.backgroundColor = '#fbbf24';
                        
                        setTimeout(() => {
                            neuron.el.classList.remove('active');
                            neuron.el.style.backgroundColor = neuron.color;
                        }, 200);
                    }
                    
                    await new Promise(r => setTimeout(r, 50 + Math.random() * 50));
                }
            }

            // Layer activity heatmap
            function updateHeatmap() {
                elements.heatmap.classList.remove('hidden');
                elements.heatmapGrid.innerHTML = '';
                
                state.network.layers.forEach((layer, layerIndex) => {
                    const activity = Math.random() * 0.7 + 0.3;
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-cell h-8 rounded flex items-center justify-center text-xs font-mono';
                    cell.style.backgroundColor = `rgba(251, 191, 36, ${activity})`;
                    cell.textContent = activity.toFixed(2);
                    elements.heatmapGrid.appendChild(cell);
                });
            }

            // Main generation flow with enhanced visualizations
            elements.generateBtn.addEventListener('click', async () => {
                const inputText = elements.userInput.value.trim();
                if (!inputText) return;
                
                // Start timing
                state.processingStartTime = Date.now();
                
                // Update UI state
                elements.generateBtn.disabled = true;
                elements.generateBtn.innerHTML = `
                    <div class="flex justify-center items-center">
                        <span>Processing</span>
                        <svg class="animate-spin h-5 w-5 ml-2" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                    </div>
                `;
                elements.outputArea.innerHTML = '';
                resetVisualization();
                
                // Step 1: Input Embedding
                elements.explanationText.innerHTML = `
                    <p><strong>üî§ Tokenization:</strong> Breaking text into tokens...</p>
                    <p class="text-xs mt-1">Each word or subword becomes a numerical vector.</p>
                `;
                
                const inputLayer = state.network.layers[0];
                let activeNeuronCount = 0;
                
                for (let i = 0; i < inputLayer.length; i++) {
                    setTimeout(() => {
                        inputLayer[i].el.classList.add('active');
                        inputLayer[i].el.style.backgroundColor = '#60a5fa';
                        activeNeuronCount++;
                        elements.activeNeurons.textContent = activeNeuronCount.toString();
                    }, i * 50);
                }
                await new Promise(r => setTimeout(r, inputLayer.length * 50 + 200));
                
                // Step 2: Forward propagation through hidden layers
                for (let layerIdx = 0; layerIdx < state.network.layers.length - 1; layerIdx++) {
                    elements.explanationText.innerHTML = `
                        <p><strong>üß† Layer ${layerIdx + 1}:</strong> ${layerIdx === 0 ? 'Pattern Recognition' : layerIdx === 1 ? 'Feature Extraction' : layerIdx === 2 ? 'Context Understanding' : 'Abstract Reasoning'}...</p>
                        <p class="text-xs mt-1">Neurons activate based on weighted inputs from previous layer.</p>
                    `;
                    
                    const currentLayer = state.network.layers[layerIdx];
                    const nextLayer = state.network.layers[layerIdx + 1];
                    
                    // Animate particles between layers
                    const particlePromises = [];
                    const activeConnections = state.network.lines.filter(
                        line => currentLayer.some(n => n.id === line.from.id) && 
                               nextLayer.some(n => n.id === line.to.id)
                    ).sort(() => 0.5 - Math.random()).slice(0, 20); // Limit particles for performance
                    
                    activeConnections.forEach((connection, idx) => {
                        setTimeout(() => {
                            connection.el.classList.add('active');
                            connection.el.style.stroke = connection.from.color;
                            particlePromises.push(animateParticle(connection.from, connection.to, connection.from.color));
                        }, idx * 20);
                    });
                    
                    await Promise.all(particlePromises);
                    
                    // Activate next layer neurons
                    nextLayer.forEach((neuron, idx) => {
                        setTimeout(() => {
                            if (Math.random() > 0.3) { // Not all neurons activate
                                neuron.el.classList.add('active');
                                neuron.el.style.backgroundColor = '#fbbf24';
                                activeNeuronCount++;
                                elements.activeNeurons.textContent = activeNeuronCount.toString();
                            }
                        }, idx * 30);
                    });
                    
                    await new Promise(r => setTimeout(r, nextLayer.length * 30 + 200));
                    updateHeatmap();
                }
                
                // Step 3: Attention mechanism visualization
                if (Math.random() > 0.5) {
                    elements.explanationText.innerHTML = `
                        <p><strong>üëÅÔ∏è Attention Mechanism:</strong> Focusing on relevant parts...</p>
                        <p class="text-xs mt-1">The model identifies which parts of the input are most important.</p>
                    `;
                    
                    // Show attention patterns
                    elements.attentionLayer.style.opacity = '1';
                    const attentionSpots = 5;
                    for (let i = 0; i < attentionSpots; i++) {
                        const spot = document.createElement('div');
                        spot.className = 'absolute rounded-full bg-yellow-400 opacity-30';
                        const size = 50 + Math.random() * 100;
                        spot.style.width = `${size}px`;
                        spot.style.height = `${size}px`;
                        spot.style.left = `${Math.random() * (elements.brainViz.clientWidth - size)}px`;
                        spot.style.top = `${Math.random() * (elements.brainViz.clientHeight - size)}px`;
                        spot.style.filter = 'blur(20px)';
                        elements.attentionLayer.appendChild(spot);
                    }
                    
                    await new Promise(r => setTimeout(r, 800));
                    elements.attentionLayer.style.opacity = '0';
                    setTimeout(() => elements.attentionLayer.innerHTML = '', 500);
                }
                
                // Step 4: API Call
                const responseText = await callGeminiAPI(inputText);
                
                // Step 5: Type out response
                await typeOutResponse(responseText);
                
                // Calculate and display metrics
                const processingTime = Date.now() - state.processingStartTime;
                elements.processingTime.textContent = `${processingTime}ms`;
                
                // Add to history
                addToHistory(inputText, responseText);
                
                // Reset UI
                resetVisualization();
                elements.generateBtn.disabled = false;
                elements.generateBtn.innerHTML = '‚ú® Generate Response';
                
                elements.explanationText.innerHTML = `
                    <p><strong>‚úÖ Complete!</strong> The neural network has processed your input.</p>
                    <p class="text-xs mt-1">Processing time: ${processingTime}ms | Active neurons: ${activeNeuronCount} | Response tokens: ${countTokens(responseText)}</p>
                    <div class="mt-3 p-3 bg-gray-800 rounded-lg">
                        <p class="text-xs"><strong>Key Insights:</strong></p>
                        <ul class="text-xs mt-1 space-y-1 list-disc list-inside">
                            <li>Each layer extracts increasingly abstract features</li>
                            <li>Attention helps focus on relevant context</li>
                            <li>The final layer converts activations to text tokens</li>
                        </ul>
                    </div>
                `;
            });

            // Add to conversation history
            function addToHistory(input, output) {
                const historyItem = {
                    input: input.substring(0, 50) + (input.length > 50 ? '...' : ''),
                    output: output.substring(0, 50) + (output.length > 50 ? '...' : ''),
                    timestamp: new Date().toLocaleTimeString()
                };
                
                state.history.push(historyItem);
                
                // Update history UI
                if (state.history.length === 1) {
                    elements.history.innerHTML = '';
                }
                
                const historyCard = document.createElement('div');
                historyCard.className = 'flex-shrink-0 bg-gray-700 rounded-lg p-3 min-w-[200px] cursor-pointer hover:bg-gray-600 transition';
                historyCard.innerHTML = `
                    <p class="text-xs text-gray-400">${historyItem.timestamp}</p>
                    <p class="text-sm font-medium mt-1">${historyItem.input}</p>
                    <p class="text-xs text-gray-400 mt-1">${historyItem.output}</p>
                `;
                
                historyCard.addEventListener('click', () => {
                    elements.userInput.value = input;
                    elements.outputArea.textContent = output;
                    elements.userInput.dispatchEvent(new Event('input'));
                });
                
                elements.history.appendChild(historyCard);
                elements.history.scrollLeft = elements.history.scrollWidth;
            }

            // Reset visualization
            function resetVisualization() {
                document.querySelectorAll('.neuron.active').forEach(n => {
                    n.classList.remove('active');
                    n.classList.remove('attention');
                    const layerIndex = parseInt(n.id.split('-')[1]);
                    n.style.backgroundColor = state.network.layers[layerIndex][0].color;
                });
                document.querySelectorAll('.line.active').forEach(l => {
                    l.classList.remove('active');
                    l.style.stroke = '#4b5563';
                });
                elements.activeNeurons.textContent = '0';
            }

            // Initialize on load
            window.addEventListener('load', () => {
                initializeBrain();
                
                // Add some initial particles for ambiance
                setInterval(() => {
                    if (document.querySelectorAll('.particle').length < 3 && !elements.generateBtn.disabled) {
                        const layers = state.network.layers;
                        const fromLayer = layers[Math.floor(Math.random() * (layers.length - 1))];
                        const toLayer = layers[Math.floor(Math.random() * (layers.length - 1)) + 1];
                        const fromNode = fromLayer[Math.floor(Math.random() * fromLayer.length)];
                        const toNode = toLayer[Math.floor(Math.random() * toLayer.length)];
                        animateParticle(fromNode, toNode, 'rgba(251, 191, 36, 0.3)');
                    }
                }, 2000);
            });
            
            // Handle window resize
            window.addEventListener('resize', () => {
                if (state.currentView === 'network') {
                    initializeBrain();
                }
            });
        });
    </script>
</body>
</html>
